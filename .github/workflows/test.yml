name: 'build-test'
on:
  pull_request:
  push:
    branches:
      - main
      - 'releases/*'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - run: npm ci

      - run: npm run all --workspaces

      - uses: ./upload-dir
        id: upload
        with:
          dir: ./upload-dir/dist

      - uses: ./write-feed
        id: feed
        with:
          reference: ${{ steps.upload.outputs.reference }}
          topic: 'swarm-actions-test'
          signer: ${{ secrets.SIGNER }}

      - uses: ./reference-to-cid
        id: cid
        with:
          reference: ${{ steps.feed.outputs.manifest }}

      - run: |
          echo 'Chunk Reference: ${{ steps.upload.outputs.reference }}'
          echo 'Feed Reference: ${{ steps.feed.outputs.reference }}'
          echo 'Feed Manifest: ${{ steps.feed.outputs.manifest }}'
          echo 'Feed Bzz.link: https://${{ steps.cid.outputs.cid }}.bzz.link'

      - uses: ./pr-preview
        id: pr-preview
        with:
          dir: ./upload-dir/dist

      - run: |
          echo 'Swarm hash: ${{ steps.pr-preview.outputs.swarm-hash }}'
          echo 'Bzz link URL: ${{ steps.pr-preview.outputs.url }}'

  test-experimental:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Install swarm-cli
        run: npm install --global @ethersphere/swarm-cli

      - name: Run all workspaces
        run: npm run all --workspaces

      - name: Create test directory with sample files
        run: |
          mkdir -p test-dir/css
          echo "<h1>Swarm Actions Test</h1>" > test-dir/index.html
          echo "body { background: red }" > test-dir/css/main.bundle.min.4e55be0357e7dec25cf1bea80877847773ee67f75d09281900b7bd8c8d07b4cded5555fb3b9c01a3826e021712d0fd63866586c0aa832ebb86de60c217a2f288.css

      - name: Upload experimentally
        uses: ./upload-dir-experimental
        id: upload
        with:
          dir: ./test-dir

      - name: Download css file with swarm-cli
        run: |
          swarm-cli download ${{ steps.upload.outputs.reference }}/css/main.bundle.min.4e55be0357e7dec25cf1bea80877847773ee67f75d09281900b7bd8c8d07b4cded5555fb3b9c01a3826e021712d0fd63866586c0aa832ebb86de60c217a2f288.css --bee-api-url https://api.gateway.ethswarm.org

    test-experimental-flags:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout repository
          uses: actions/checkout@v4

        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
            node-version: '20'

        - name: Install dependencies
          run: npm ci

        - name: Install swarm-cli
          run: npm install --global @ethersphere/swarm-cli

        - name: Run all workspaces
          run: npm run all --workspaces

        - name: Create test directory with sample files
          run: |
            mkdir -p test-dir
            echo "<h1>Swarm Actions Test</h1>" > test-dir/hello.html

        - name: Upload experimentally with index and error documents
          uses: ./upload-dir-experimental
          id: upload
          with:
            dir: ./test-dir
            index-document: hello.html
            error-document: error.html

        - name: Verify index and error document metadata
          run: |
            npx npxie eval-and-expect \
              "swarm-cli manifest list --verbose ${{ steps.upload.outputs.reference }} --bee-api-url https://api.gateway.ethswarm.org" \
              "website-index-document: hello.html\nwebsite-error-document: error.html"
